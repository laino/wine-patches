From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Nils Kuhnhenn <kuhnhenn.nils@gmail.com>
Date: Sat, 6 Aug 2016 16:25:27 +0200
Subject: [PATCH 7/7] wined3d: use SwitchToThread() and calls to select() in
 busy-loops

---
 dlls/wined3d/wined3d_private.h | 40 +++++++++++++++++++++++++++++++++++++++-
 1 file changed, 39 insertions(+), 1 deletion(-)

diff --git a/dlls/wined3d/wined3d_private.h b/dlls/wined3d/wined3d_private.h
index 4c70c970bc..0cd0b11e88 100644
--- a/dlls/wined3d/wined3d_private.h
+++ b/dlls/wined3d/wined3d_private.h
@@ -2741,9 +2741,47 @@ static inline void wined3d_resource_release(struct wined3d_resource *resource)
     InterlockedDecrement(&resource->access_count);
 }
 
+#if defined(STAGING_CSMT)
+#define WINED3D_YIELD_SPIN_TIME  1000 /* 1000 = 0.1 milliseconds = 100 microseconds */
+
+static LARGE_INTEGER wined3d_cs_mt_yield(LARGE_INTEGER *spin_start)
+{
+    struct timeval tv;
+    LARGE_INTEGER now, diff;
+
+    NtQuerySystemTime(&now);
+
+    if (spin_start->QuadPart <= 0)
+        spin_start->QuadPart = now.QuadPart;
+
+    diff.QuadPart = now.QuadPart - spin_start->QuadPart;
+
+    if (diff.QuadPart > WINED3D_YIELD_SPIN_TIME)
+    {
+        tv.tv_sec = 0;
+        tv.tv_usec = 9;
+        select( 0, NULL, NULL, NULL, &tv);
+    }
+    else
+        SwitchToThread();
+
+    return diff;
+}
+#endif /* STAGING_CSMT */
+
 static inline void wined3d_resource_wait_idle(struct wined3d_resource *resource)
 {
-    while (InterlockedCompareExchange(&resource->access_count, 0, 0));
+#if defined(STAGING_CSMT)
+    LARGE_INTEGER spin_start;
+    spin_start.QuadPart = 0;
+#endif /* STAGING_CSMT */
+
+    while (InterlockedCompareExchange(&resource->access_count, 0, 0))
+    {
+#if defined(STAGING_CSMT)
+        wined3d_cs_mt_yield(&spin_start);
+#endif /* STAGING_CSMT */
+    }
 }
 
 void resource_cleanup(struct wined3d_resource *resource) DECLSPEC_HIDDEN;
-- 
2.11.1

